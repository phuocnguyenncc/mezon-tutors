// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// ENUMS
// ============================================================

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum AgeGroup {
  TEEN
  TWENTIES
  THIRTIES
  FORTIES_PLUS
  FIFTIES_PLUS
}

enum UserStatus {
  ONLINE
  OFFLINE
  VOICE_AVAILABLE
}

enum FriendRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum MessageType {
  TEXT
  IMAGE
  SYSTEM
}

// enum ReportReason {
//   SPAM
//   HARASSMENT
//   INAPPROPRIATE_CONTENT
//   FAKE_PROFILE
//   OTHER
// }

// enum ReportStatus {
//   PENDING
//   REVIEWED
//   RESOLVED
// }

enum TransactionType {
  PURCHASE_TICKETS
  PURCHASE_SUPER_TICKETS
  PURCHASE_BOOSTS
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// enum Currency {
//   USD
//   JPY
//   EUR
//   GBP
//   KRW
//   CNY
// }

enum ItemType {
  TICKET
  SUPER_TICKET
  BOOST
}

enum NotificationType {
  FRIEND_REQUEST
  FRIEND_ACCEPTED
  PROFILE_VIEW
  MESSAGE_RECEIVED
  SYSTEM
}

enum Platform {
  PLAYSTATION
  XBOX
  PC
  SWITCH
  MOBILE
  SMARTPHONE
  VR
}

enum StreamingPlatform {
  TWITCH
  YOUTUBE
  TIKTOK
  FACEBOOK_GAMING
  OTHER
}

enum MBTIType {
  INTJ
  INTP
  ENTJ
  ENTP
  INFJ
  INFP
  ENFJ
  ENFP
  ISTJ
  ISFJ
  ESTJ
  ESFJ
  ISTP
  ISFP
  ESTP
  ESFP
}

enum VoiceChatAvailability {
  ALWAYS
  SOMETIMES
  NEVER
}

enum DayPeriod {
  MORNING
  NOON
  EVENING
  NIGHT
  LATE_NIGHT
}

enum UserGameLevel {
  MASTER
  BEGINNER
}

// enum BlockReason {
//   SPAM
//   HARASSMENT
//   INAPPROPRIATE
//   OTHER
// }

// ============================================================
// AUTHENTICATION
// ============================================================

// Authentication session management
model Session {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String   @db.Uuid
  token        String   @unique
  refreshToken String?  @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

// Email verification codes (6-digit)
model EmailVerificationCode {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email     String
  code      String // 6-digit code
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email, code, expiresAt])
  @@index([expiresAt])
}

// ============================================================
// APP CONFIG
// ============================================================

model AppConfig {
  id                         String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  homeCollections            Json   @default("[]")
  horizontalListDefaultLimit Int    @default(20)
  // Add new columns here for future configs

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================================
// USER & PROFILE
// ============================================================

model User {
  id       String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email    String     @unique
  nickname String
  gender   Gender
  avatar   String?
  cover    String?
  bio      String?    @db.Text
  dob      DateTime
  ageGroup AgeGroup
  status   UserStatus @default(OFFLINE)

  // Enhanced Profile
  mbti         MBTIType?
  // voiceChatAvailability       VoiceChatAvailability?
  // isGhostMode                 Boolean                @default(false)
  // profileCompletionPercentage Int       @default(0)
  lastActiveAt DateTime
  // referralCode String?   @unique

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // soft delete

  // Auth relations
  sessions Session[]

  // Relations
  // Relations
  games          UserGame[]
  availableTimes UserAvailableTime[]
  platforms      UserPlatform[]
  tags           UserTag[]
  streamers      UserStreamer[]
  inventory      Inventory?
  transactions   Transaction[]
  notifications  Notification[]

  // Profile Boost (Merged for performance)
  boostExpiresAt DateTime? // If present and > now(), user is boosted

  // Blocking
  // blockedUsers   UserBlock[] @relation("BlockerUser")
  // blockedByUsers UserBlock[] @relation("BlockedUser")

  // // Referrals
  // referrals  Referral[] @relation("ReferrerUser")
  // referredBy Referral?  @relation("ReferredUser")

  // Friend requests
  sentRequests     FriendRequest[] @relation("SentRequests")
  receivedRequests FriendRequest[] @relation("ReceivedRequests")

  // Profile visits
  visitsReceived ProfileVisit[] @relation("VisitedUser")
  visitsMade     ProfileVisit[] @relation("VisitorUser")

  // Chat
  chatRoomsAsUser1 ChatRoom[] @relation("ChatUser1")
  chatRoomsAsUser2 ChatRoom[] @relation("ChatUser2")
  messages         Message[]

  // Moderation
  // reportsReceived Report[] @relation("ReportedUser")
  // reportsMade     Report[] @relation("ReporterUser")

  @@index([status])
  @@index([deletedAt])
  @@index([lastActiveAt])
  @@index([deletedAt, status])
}

model UserPlatform {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @db.Uuid
  platform  Platform
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, platform])
  @@index([userId])
}

// ============================================================
// TAGS & CATEGORIES
// ============================================================

model TagCategory {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String   @unique // "Level", "Age Group", "Style", "Language"
  displayOrder Int      @default(0)
  createdAt    DateTime @default(now())

  tags Tag[]
}

model Tag {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  categoryId String   @db.Uuid
  name       String // "Beginner-Friendly", "No Toxic", "Japanese", etc.
  createdAt  DateTime @default(now())

  category TagCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  users    UserTag[]

  @@unique([categoryId, name])
}

model UserTag {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @db.Uuid
  tagId     String   @db.Uuid
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([userId, tagId])
  @@index([userId])
}

// ============================================================
// STREAMERS
// ============================================================

model Streamer {
  id         String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name       String             @unique
  platform   StreamingPlatform?
  channelUrl String?
  createdAt  DateTime           @default(now())

  followers UserStreamer[]
}

model UserStreamer {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String   @db.Uuid
  streamerId String   @db.Uuid
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  streamer Streamer @relation(fields: [streamerId], references: [id], onDelete: Cascade)

  @@unique([userId, streamerId])
  @@index([userId])
}

// ============================================================
// PREMIUM & SHOP
// ============================================================

// Subscription model removed for MVP

model Inventory {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String   @unique @db.Uuid
  tickets         Int      @default(0)
  superTickets    Int      @default(0)
  boosts          Int      @default(0) // Inventory of consumable boosts
  lastTicketReset DateTime @default(now()) // Daily ticket refresh
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ShopItem {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type      ItemType
  quantity  Int // How many items in this pack (e.g., 10, 100, 1000)
  price     Int // Price in JPY
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
}

model Transaction {
  id     String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId String            @db.Uuid
  type   TransactionType // What kind of transaction
  status TransactionStatus @default(PENDING)

  // Item details (for purchases)
  itemType ItemType? // TICKET, SUPER_TICKET, or BOOST
  quantity Int? // How many items (e.g., 100 tickets)

  // Payment info
  amount Int? // Amount in JPY

  // Payment provider info
  paymentProvider String? // "stripe", "iap"
  paymentId       String? // External payment ID for reconciliation

  // Flexible metadata for additional data
  metadata Json? // e.g., { referredUserId, refundReason, etc. }

  createdAt   DateTime  @default(now())
  completedAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([status])
  @@index([paymentProvider, paymentId])
}

// ============================================================
// GAMES
// ============================================================

model Game {
  id      String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name    String  @unique
  iconUrl String?

  createdAt DateTime @default(now())

  users UserGame[]
}

model UserGame {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String        @db.Uuid
  gameId      String        @db.Uuid
  level       UserGameLevel
  description String?       @db.VarChar(200)

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  game Game @relation(fields: [gameId], references: [id], onDelete: Cascade)

  @@unique([userId, gameId])
  @@index([gameId])
}

// ============================================================
// AVAILABLE TIME
// ============================================================

model UserAvailableTime {
  id     String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId String    @db.Uuid
  period DayPeriod

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, period])
  @@index([userId])
}

// ============================================================
// FRIEND SYSTEM
// ============================================================

model FriendRequest {
  id             String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  senderId       String              @db.Uuid
  receiverId     String              @db.Uuid
  status         FriendRequestStatus @default(PENDING)
  message        String?             @db.VarChar(200)
  isSuperRequest Boolean             @default(false)

  createdAt   DateTime  @default(now())
  respondedAt DateTime?

  sender   User @relation("SentRequests", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("ReceivedRequests", fields: [receiverId], references: [id], onDelete: Cascade)

  @@unique([senderId, receiverId])
  @@index([receiverId, status])
}

model ProfileVisit {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  visitorId String   @db.Uuid
  visitedId String   @db.Uuid
  visitedAt DateTime @default(now())

  visitor User @relation("VisitorUser", fields: [visitorId], references: [id], onDelete: Cascade)
  visited User @relation("VisitedUser", fields: [visitedId], references: [id], onDelete: Cascade)

  @@index([visitedId, visitedAt])
}

// model UserBlock {
//   id        String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
//   blockerId String      @db.Uuid // User who blocked
//   blockedId String      @db.Uuid // User who was blocked
//   reason    BlockReason
//   note      String?     @db.Text
//   createdAt DateTime    @default(now())

//   blocker User @relation("BlockerUser", fields: [blockerId], references: [id], onDelete: Cascade)
//   blocked User @relation("BlockedUser", fields: [blockedId], references: [id], onDelete: Cascade)

//   @@unique([blockerId, blockedId])
//   @@index([blockerId])
//   @@index([blockedId])
// }

// model Referral {
//   id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
//   referrerId    String    @db.Uuid // User who referred
//   referredId    String    @unique @db.Uuid // User who was referred
//   rewardClaimed Boolean   @default(false)
//   claimedAt     DateTime?
//   createdAt     DateTime  @default(now())

//   referrer User @relation("ReferrerUser", fields: [referrerId], references: [id], onDelete: Cascade)
//   referred User @relation("ReferredUser", fields: [referredId], references: [id], onDelete: Cascade)

//   @@index([referrerId])
//   @@index([referredId])
// }

// ============================================================
// CHAT
// ============================================================

model ChatRoom {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user1Id       String    @db.Uuid
  user2Id       String    @db.Uuid
  lastMessageAt DateTime?

  createdAt DateTime @default(now())

  user1    User      @relation("ChatUser1", fields: [user1Id], references: [id], onDelete: Cascade)
  user2    User      @relation("ChatUser2", fields: [user2Id], references: [id], onDelete: Cascade)
  messages Message[]

  @@unique([user1Id, user2Id])
  @@index([user1Id, lastMessageAt])
  @@index([user2Id, lastMessageAt])
}

model Message {
  id         String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  chatRoomId String      @db.Uuid
  senderId   String      @db.Uuid
  type       MessageType @default(TEXT)
  content    String      @db.Text
  imageUrl   String?

  createdAt DateTime  @default(now())
  readAt    DateTime?

  chatRoom ChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  sender   User     @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([chatRoomId, createdAt])
  @@index([senderId])
}

// ============================================================
// MODERATION & NOTIFICATIONS
// ============================================================

// model Report {
//   id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
//   reporterId     String       @db.Uuid
//   reportedUserId String       @db.Uuid
//   reason         ReportReason
//   description    String?      @db.Text
//   status         ReportStatus @default(PENDING)

//   createdAt  DateTime  @default(now())
//   reviewedAt DateTime?

//   reporter     User @relation("ReporterUser", fields: [reporterId], references: [id], onDelete: Cascade)
//   reportedUser User @relation("ReportedUser", fields: [reportedUserId], references: [id], onDelete: Cascade)

//   @@index([status])
//   @@index([reportedUserId])
// }

model Notification {
  id        String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String           @db.Uuid
  type      NotificationType
  title     String
  message   String?
  metadata  Json? // Flexible data: { relatedUserId, requestId, chatRoomId, etc. }
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead, createdAt])
}
